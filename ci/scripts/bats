#!/bin/bash

(
  set -e
 
  base=$( cd "$( dirname "$( dirname "$( dirname "$0" )")")" && pwd )
  base_gopath=$( cd $base/../../../.. && pwd )

  export GOPATH=$base/Godeps/_workspace:$base_gopath:$GOPATH

  echo -e "\n Get stemcell version..."
  s3cmd get s3://bosh-softlayer-cpi-stemcells/stemcell-version stemcell-version --access_key=$S3_ACCESS_KEY --secret_key=$S3_SECRET_KEY
  STEMCELL_VERSION=`cat stemcell-version`

  echo $STEMCELL_VERSION

  LIGHT_STEMCELL=light-bosh-stemcell-$STEMCELL_VERSION-softlayer-esxi-ubuntu-trusty-go_agent.tgz

  # s3cmd get s3://bosh-softlayer-cpi-stemcells/$LIGHT_STEMCELL --access_key=$S3_ACCESS_KEY --secret_key=$S3_SECRET_KEY

  pwd

  apt-get update
  apt-get install -y libsqlite3-dev
  apt-get install -y libmysqlclient-dev
  apt-get install -y libpq-dev --fix-missing

  cd gopath/src/github.com/cloudfoundry/bosh/bat

  bundle install


  cd gopath/src/github.com/maximilien/bosh-softlayer-cpi-release

  pwd
  ls
  ls /sbin

  VBoxManage --version

  vagrant up
)
