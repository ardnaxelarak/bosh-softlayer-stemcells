#!/bin/bash

(
  set -e
 
  base=$( cd "$( dirname "$( dirname "$( dirname "$0" )")")" && pwd )
  base_gopath=$( cd $base/../../../.. && pwd )

  export GOPATH=$base/Godeps/_workspace:$base_gopath:$GOPATH

  cat /etc/apt/sources.list

  echo -e "\n Get stemcell version..."
  s3cmd get s3://bosh-softlayer-cpi-stemcells/stemcell-version stemcell-version --access_key=$S3_ACCESS_KEY --secret_key=$S3_SECRET_KEY
  STEMCELL_VERSION=`cat stemcell-version`

  echo $STEMCELL_VERSION

  LIGHT_STEMCELL=light-bosh-stemcell-$STEMCELL_VERSION-softlayer-esxi-ubuntu-trusty-go_agent.tgz

  # s3cmd get s3://bosh-softlayer-cpi-stemcells/$LIGHT_STEMCELL --access_key=$S3_ACCESS_KEY --secret_key=$S3_SECRET_KEY

  pwd

  echo $(lsb-release -sc)

  apt-get update

  apt-get install -y dkms
  apt-get install -y libsqlite3-dev libmysqlclient-dev postgresql libpq-dev module-init-tools virtualbox
  apt-get install -y linux-image-3.16.0-4-amd64 linux-headers-3.16.0-4-amd64

  apt-get install -y python3
  apt-get install -y software-properties-common

  add-apt-repository "deb http://security.ubuntu.com/ubuntu trusty-security main"

  apt-get update

  uname -a
  uname -r

  apt-cache search linux-headers
  apt-cache search linux-image

  apt-get install -y --force-yes linux-headers-$(uname -r)

  ls /usr/src

  cd gopath/src/github.com/cloudfoundry/bosh-acceptance-tests

  ./write_gemfile

  bundle install

  cd $base_gopath/src/github.com/maximilien/bosh-softlayer-cpi-release

  lsmod

  modprobe vboxdrv

  /etc/init.d/vboxdrv setup

  cat /var/log/vbox-install.log


  VBoxManage --version

  vagrant up
)
